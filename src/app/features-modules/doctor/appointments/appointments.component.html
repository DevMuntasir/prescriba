<div class="min-h-screen bg-brand-surface py-10">
  <div class="max-w-6xl mx-auto px-4 space-y-8">
    <header class="flex flex-wrap items-start justify-between gap-4">
      <div class="space-y-2">
        <p class="text-sm uppercase tracking-[0.3em] text-brand-primary font-semibold">Appointments</p>
        <h1 class="text-3xl font-bold text-slate-900">Today's queue</h1>
        <p class="text-slate-600 max-w-2xl text-base">Monitor every appointment at a glance and quickly add walk-in patients when needed.</p>
      </div>
      <button type="button" class="px-5 py-2.5 rounded-xl bg-brand-primary text-white font-semibold shadow-lg shadow-brand-primary/30"
        (click)="openForm()">
        + New appointment
      </button>
    </header>

    <div *ngIf="lastGeneratedSerial" class="rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-900">
      Appointment created successfully. Serial: <span class="font-semibold">{{ lastGeneratedSerial }}</span>
    </div>

    <section class="bg-white rounded-3xl shadow-2xl shadow-emerald-200/40 border border-emerald-50">
      <div class="overflow-x-auto">
        <div *ngIf="isLoadingAppointments" class="px-6 py-4 text-sm text-slate-600">Loading appointments...</div>
        <div *ngIf="appointmentsLoadError" class="px-6 py-4 text-sm text-red-700 bg-red-50 border-t border-red-100">{{ appointmentsLoadError }}</div>
        <ng-container *ngIf="!isLoadingAppointments && !appointmentsLoadError">
        <table *ngIf="appointments.length > 0" class="w-full text-sm text-slate-700">
          <thead class="text-left bg-slate-100 text-slate-600">
            <tr>
              <th class="py-3 px-4 font-semibold">Serial</th>
              <th class="py-3 px-4 font-semibold">Patient</th>
              <th class="py-3 px-4 font-semibold">Age</th>
              <th class="py-3 px-4 font-semibold">Gender</th>
              <th class="py-3 px-4 font-semibold">Contact</th>
              <th class="py-3 px-4 font-semibold">Date &amp; Time</th>
              <th class="py-3 px-4 font-semibold">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let appointment of appointments; trackBy: trackBySerial" class="border-b border-slate-100">
              <td class="py-3 px-4 font-semibold text-slate-900">{{ appointment.serial }}</td>
              <td class="py-3 px-4">{{ appointment.patientName }}</td>
              <td class="py-3 px-4">{{ appointment.age }}</td>
              <td class="py-3 px-4">{{ appointment.gender }}</td>
              <td class="py-3 px-4">{{ appointment.contactNumber }}</td>
              <td class="py-3 px-4">{{ appointment.appointmentDate }}</td>
              <td class="py-3 px-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"
                  [ngClass]="{
                    'bg-emerald-100 text-emerald-700': appointment.status === 'Confirmed',
                    'bg-blue-100 text-blue-700': appointment.status === 'Checked In',
                    'bg-amber-100 text-amber-700': appointment.status === 'Pending'
                  }">
                  {{ appointment.status }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="appointments.length === 0" class="px-6 py-12 text-center text-sm text-slate-500">
          No appointments scheduled yet.
        </div>
        </ng-container>
      </div>
    </section>
  </div>

  <!-- Sheet -->
  <div class="fixed inset-0 z-40" *ngIf="isFormOpen">
    <div class="absolute inset-0 bg-slate-900/40" (click)="closeForm()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-3xl bg-white shadow-2xl flex flex-col">
      <header class="flex items-start justify-between gap-4 border-b border-slate-100 px-6 py-5">
        <div>
          <p class="text-sm uppercase tracking-[0.4em] text-brand-primary font-semibold">Hospitals</p>
          <h2 class="text-2xl font-bold text-slate-900">Your chambers</h2>
        </div>
        <button type="button" class="px-3 py-1 rounded-full bg-emerald-50 text-brand-primary font-semibold" (click)="closeForm()">Close</button>
      </header>

      <div class="flex-1 overflow-y-auto px-6 pb-8 pt-6 space-y-4">
        <div *ngIf="isLoadingChambers" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
          Loading your hospitals...
        </div>

        <div *ngIf="!isLoadingChambers && chamberLoadError" class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
          {{ chamberLoadError }}
        </div>

        <div *ngIf="!isLoadingChambers && !chamberLoadError && chambers.length === 0" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500">
          No hospitals found yet. Add a hospital from the Hospital tab to see it here.
        </div>

        <div *ngIf="!isLoadingChambers && chambers.length > 0" class="space-y-5">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <article
              *ngFor="let chamber of chambers; trackBy: trackByChamber"
              (click)="onChamberSelected(chamber)"
              class="rounded-2xl border border-slate-100 bg-white p-3 cursor-pointer transition hover:shadow-lg"
              [ngClass]="isChamberSelected(chamber.id ?? null)
                ? 'border-brand-primary shadow-brand-primary/30 shadow-lg ring-2 ring-brand-primary/20'
                : 'hover:border-brand-primary/40'">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h3 class="text-md font-Roboto text-slate-900">{{ chamber.chamberName }}</h3>
                  <p class="text-sm text-slate-500">{{ chamber.address }}</p>
                </div>
                <span *ngIf="isChamberSelected(chamber.id ?? null)" class="text-xs font-semibold text-brand-primary">
                  Selected
                </span>
              </div>
            </article>
          </div>

          <section class="rounded-2xl border border-slate-100 bg-slate-50/70 p-4" *ngIf="selectedChamber as activeChamber; else selectChamberNote">
            <!-- <header class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-brand-primary font-semibold">Weekly availability</p>
                <h3 class="text-xl font-semibold text-slate-900">{{ activeChamber.chamberName }}</h3>
                <p class="text-sm text-slate-500">{{ activeChamber.address }}</p>
              </div>
              <span class="text-xs text-slate-500">ID: {{ activeChamber.id }}</span>
            </header> -->

            <div *ngIf="isLoadingSchedules" class="mt-4 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600">
              Loading schedules for this chamber...
            </div>

            <div *ngIf="scheduleLoadError" class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
              {{ scheduleLoadError }}
            </div>

            <div *ngIf="!isLoadingSchedules && !scheduleLoadError && schedules.length === 0" class="mt-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
              No saved schedules were found for this chamber.
            </div>

            <div *ngIf="!isLoadingSchedules && !scheduleLoadError && schedules.length > 0" class="mt-4 space-y-4">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Week days</p>
                <div class="mt-2 flex flex-wrap gap-2">
                  <button type="button" *ngFor="let day of weekDays" (click)="selectWeekDay(day.key)"
                    [disabled]="!hasSessionsForDay(day.key)"
                    class="px-3 py-1 rounded-full border text-sm font-semibold transition"
                    [ngClass]="{
                      'bg-brand-primary text-white border-brand-primary shadow-sm shadow-brand-primary/40': selectedWeekDay === day.key,
                      'border-emerald-300 bg-emerald-50 text-emerald-800': selectedWeekDay !== day.key && hasSessionsForDay(day.key),
                      'border-slate-200 text-slate-400 cursor-not-allowed opacity-60': !hasSessionsForDay(day.key)
                    }">
                    {{ day.label }}
                  </button>
                </div>
              </div>

              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Pick appointment date</p>
                <div class="mt-2 flex flex-col gap-2 sm:flex-row sm:items-center">
                  <input type="date" class="rounded-xl border border-slate-200 px-4 py-2 text-sm"
                    [min]="todayDate"
                    [value]="selectedBookingDate ?? ''"
                    (change)="handleBookingDateChange($any($event.target).value)" />
                  <span class="text-sm text-slate-600" *ngIf="selectedBookingDate">
                    Selected: {{ selectedBookingDate | date: 'fullDate' }}
                  </span>
                </div>
                <p *ngIf="bookingDateError" class="text-xs text-red-600 mt-1">{{ bookingDateError }}</p>
              </div>

              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Available sessions</p>
                <!-- <div *ngIf="isCreatingAppointment" class="mt-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600">Creating appointment...</div> -->
                <!-- <div *ngIf="appointmentCreationError" class="mt-2 rounded-xl border border-red-200 bg-red-50 px-4 py-2 text-xs text-red-700">{{ appointmentCreationError }}</div> -->
                <div *ngIf="sessionsForSelectedDay.length === 0" class="mt-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600">
                  Select a highlighted day to view its sessions.
                </div>

                <div *ngIf="sessionsForSelectedDay.length > 0" class="mt-3 space-y-3">
                  <article *ngFor="let session of sessionsForSelectedDay; trackBy: trackBySession"
                    class="rounded-2xl border border-slate-200 bg-white p-4 cursor-pointer transition hover:shadow-md focus-within:ring-2 focus-within:ring-brand-primary"
                    role="button"
                    tabindex="0"
                    (click)="openSessionBooking(session)"
                    (keydown)="onSessionKeydown($event, session)">
                    <header class="flex flex-wrap items-center justify-between gap-3">
                      <div>
                        <h4 class="text-sm font-semibold text-slate-900">{{ session.scheduleName || 'Untitled schedule' }}</h4>
                        <p class="text-xs text-slate-500">{{ session.scheduleTypeName || '&mdash;' }} &middot; {{ session.consultancyTypeName || '&mdash;' }}</p>
                      </div>
                      <span class="px-3 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="session.isActive === false ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'">
                        {{ session.isActive === false ? 'Inactive' : 'Active' }}
                      </span>
                    </header>
                    <div class="mt-3 text-sm text-slate-700">
                      <strong class="text-base text-brand-primary">{{ formatTimeLabel(session.startTime) }} - {{ formatTimeLabel(session.endTime) }}</strong>
                      <span *ngIf="session.noOfPatients" class="ml-3 text-xs text-slate-500">{{ session.noOfPatients }} patients</span>
                    </div>
                    <footer class="mt-3 text-xs text-slate-500" *ngIf="selectedBookingDate">
                      Click to create an appointment for {{ selectedBookingDate | date: 'fullDate' }}.
                    </footer>
                  </article>
                </div>
              </div>
            </div>
          </section>
          <ng-template #selectChamberNote>
            <div class="rounded-2xl border border-slate-200 bg-white px-4 py-4 text-sm text-slate-600">
              Select a chamber to preview its weekly availability and the sessions you can book against it.
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

