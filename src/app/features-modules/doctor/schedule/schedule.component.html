<div class="schedule-page">
  <div class="schedule-page__container">
    <section class="schedule-section">
      <header class="schedule-section__header">
        <div>
          <h1>Chamber Schedules</h1>
          <p>
            Manage every location where you consult patients. Create flexible day and time combinations for each chamber so your availability always stays accurate.
          </p>
        </div>
        <button type="button" class="btn btn-light" (click)="refreshSchedules()" [disabled]="isLoadingSchedules">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
              d="M4 4v6h6M20 20v-6h-6M5.1 12A7 7 0 0 1 12 5a7 7 0 0 1 6.9 5.7M18.9 12A7 7 0 0 1 12 19a7 7 0 0 1-6.9-5.7" />
          </svg>
          Refresh
        </button>
      </header>

      <div *ngIf="loadError" class="alert alert-error">
        {{ loadError }}
      </div>

      <div class="schedule-grid" [class.schedule-grid--disabled]="scheduleDetailsForm.disabled">
        <form [formGroup]="scheduleDetailsForm" class="card card--form" (ngSubmit)="saveSchedule()">
          <h2>New schedule</h2>
          <div class="form-grid">
            <label>
              <span>Select chamber</span>
              <select formControlName="doctorChamberId" [disabled]="isLoadingChambers">
                <option value="" disabled selected>Select a chamber</option>
                <option *ngFor="let chamber of chambers" [ngValue]="chamber.id ?? null">
                  {{ chamber.chamberName }}
                </option>
              </select>
              <small *ngIf="scheduleDetailsForm.controls.doctorChamberId.invalid && scheduleDetailsForm.controls.doctorChamberId.touched">
                Chamber selection is required.
              </small>
            </label>

            <label>
              <span>Schedule name (optional)</span>
              <input type="text" formControlName="scheduleName" maxlength="150" placeholder="e.g. Evening shift" />
              <small *ngIf="scheduleDetailsForm.controls.scheduleName.invalid && scheduleDetailsForm.controls.scheduleName.touched">
                Schedule name can be up to 150 characters.
              </small>
            </label>

            <label>
              <span>Schedule type</span>
              <select formControlName="scheduleType">
                <option *ngFor="let option of scheduleTypeChoices" [ngValue]="option.value">
                  {{ option.name }}
                </option>
              </select>
            </label>

            <label>
              <span>Consultancy type</span>
              <select formControlName="consultancyType">
                <option *ngFor="let option of consultancyTypeChoices" [ngValue]="option.value">
                  {{ option.name }}
                </option>
              </select>
            </label>
          </div>

          <div class="toggle-row">
            <label class="toggle">
              <input type="checkbox" formControlName="isActive" />
              <span>Keep this schedule active</span>
            </label>
          </div>

          <div class="divider"></div>

          <h3>Days &amp; time</h3>

          <div class="day-selector">
            <button type="button" class="day-selector__item" *ngFor="let day of daysOfWeek"
              [class.day-selector__item--selected]="dayIsSelected(day.value)"
              (click)="toggleDay(day.value, !dayIsSelected(day.value))">
              {{ day.label }}
            </button>
          </div>
          <p class="helper-text">You can select multiple days at once.</p>

          <div [formGroup]="sessionForm" class="session-grid">
            <label>
              <span>Start time</span>
              <input type="time" formControlName="startTime" />
              <small *ngIf="sessionForm.controls.startTime.invalid && sessionForm.controls.startTime.touched">
                Start time is required.
              </small>
            </label>

            <label>
              <span>End time</span>
              <input type="time" formControlName="endTime" />
              <small *ngIf="sessionForm.controls.endTime.invalid && sessionForm.controls.endTime.touched">
                End time is required.
              </small>
            </label>

            <label>
              <span>Patient capacity (optional)</span>
              <input type="number" min="1" max="999" formControlName="noOfPatients" placeholder="e.g. 15" />
              <small *ngIf="sessionForm.controls.noOfPatients.invalid && sessionForm.controls.noOfPatients.touched">
                Patient capacity must be between 1 and 999.
              </small>
            </label>

            <div class="session-grid__cta">
              <button type="button" class="btn btn-secondary" (click)="addSession()">Add session</button>
            </div>
          </div>

          <div *ngIf="!hasSessions" class="empty-state">
            No sessions added yet. Use the controls above to add day and time combinations.
          </div>

          <ul *ngIf="hasSessions" class="session-list">
            <li *ngFor="let session of sessionDrafts">
              <div class="session-list__content">
                <span class="session-list__day">{{ getDayLabel(session.day) }}</span>
                <strong>{{ formatTimeLabel(session.startTime) }} - {{ formatTimeLabel(session.endTime) }}</strong>
                <span *ngIf="session.noOfPatients" class="session-list__meta">
                  {{ session.noOfPatients }} patients
                </span>
              </div>
              <button type="button" class="session-list__remove" (click)="removeSession(session.id)" aria-label="Remove">
                &times;
              </button>
            </li>
          </ul>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || scheduleDetailsForm.disabled">
              <svg *ngIf="isSubmitting" class="spinner" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke-width="4" />
                <path stroke-linecap="round" d="M4 12a8 8 0 018-8" stroke-width="4" />
              </svg>
              Save schedule
            </button>
          </div>
        </form>

        <aside class="card card--info">
          <h2>Chambers</h2>
          <div *ngIf="isLoadingChambers" class="info-message">
            Loading chamber details...
          </div>
          <div *ngIf="!isLoadingChambers && chambers.length === 0" class="info-message">
            No chambers found. Add a hospital or chamber first to create schedules.
          </div>
          <ul *ngIf="!isLoadingChambers && chambers.length > 0" class="chamber-list">
            <li *ngFor="let chamber of chambers" [class.chamber-list__item--selected]="scheduleDetailsForm.value.doctorChamberId === (chamber.id ?? null)"
              (click)="scheduleDetailsForm.patchValue({ doctorChamberId: chamber.id ?? null })">
              <strong>{{ chamber.chamberName }}</strong>
              <span>{{ chamber.address }}</span>
            </li>
          </ul>
        </aside>
      </div>
    </section>

    <section class="schedule-section">
      <header class="schedule-section__header">
        <div>
          <h2>Saved schedules</h2>
          <p>Review every schedule you have created, grouped by chamber.</p>
        </div>
      </header>

      <div *ngIf="isLoadingSchedules" class="card card--list">
        Loading schedules...
      </div>

      <div *ngIf="scheduleLoadError" class="alert alert-error">
        {{ scheduleLoadError }}
      </div>

      <div *ngIf="!isLoadingSchedules && !scheduleLoadError && !hasSchedules" class="card card--list">
        No schedules yet.
      </div>

      <div *ngIf="!isLoadingSchedules && hasSchedules" class="schedule-list">
        <article *ngFor="let chamber of chambers" class="schedule-list__group" [hidden]="getSchedulesByChamberId(chamber.id).length === 0">
          <header>
            <h3>{{ chamber.chamberName }}</h3>
            <span>{{ chamber.address }}</span>
          </header>
          <div class="schedule-list__items">
            <div *ngFor="let schedule of getSchedulesByChamberId(chamber.id)" class="schedule-card">
              <div class="schedule-card__header">
                <h4>{{ schedule.scheduleName || 'Untitled schedule' }}</h4>
                <span class="badge" [class.badge--inactive]="schedule.isActive === false">
                  {{ schedule.isActive === false ? 'Inactive' : 'Active' }}
                </span>
              </div>

              <dl class="schedule-card__meta">
                <div>
                  <dt>Schedule type</dt>
                  <dd>{{ schedule.scheduleTypeName || schedule.scheduleType }}</dd>
                </div>
                <div>
                  <dt>Consultancy</dt>
                  <dd>{{ schedule.consultancyTypeName || schedule.consultancyType }}</dd>
                </div>
              </dl>

              <ul class="schedule-card__sessions">
                <li *ngFor="let session of schedule.doctorScheduleDaySession">
                  <span>{{ getDayLabel(session.scheduleDayofWeek || '') }}</span>
                  <strong>{{ formatTimeLabel(session.startTime) }} - {{ formatTimeLabel(session.endTime) }}</strong>
                  <span *ngIf="session.noOfPatients">({{ session.noOfPatients }} patients)</span>
                </li>
              </ul>

              <footer *ngIf="schedule.remarks" class="schedule-card__footer">
                {{ schedule.remarks }}
              </footer>
            </div>
          </div>
        </article>
      </div>
    </section>
  </div>
</div>
