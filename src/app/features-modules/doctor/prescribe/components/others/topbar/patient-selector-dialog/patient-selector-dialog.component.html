<div class="w-full max-w-xl space-y-5 p-8">
  <div class="space-y-1">
    <h2 class="text-xl font-semibold text-brand-neutral">Patient lookup</h2>
    <p class="text-sm text-brand-neutral/70">
      Search by mobile number or add the patient manually when the profile is new.
    </p>
  </div>

  @if (!showManualEntry) {
  <form class="space-y-3" [formGroup]="searchForm" (ngSubmit)="searchPatient()">
    <label class="block text-sm font-medium text-brand-neutral" for="patientMobile">Mobile number</label>
    <input
      id="patientMobile"
      type="tel"
      formControlName="mobileNo"
      class="w-full rounded-xl border border-brand-border px-4 py-2 text-base focus:border-brand-primary focus:outline-none"
      placeholder="e.g. 01XXXXXXXXX"
    />
    @if (searchAttempted && mobileNoControl?.invalid) {
    <p class="text-sm text-red-500">Please enter a valid mobile number.</p>
    }
    <div class="flex items-center gap-3">
      <button
        type="submit"
        class="rounded-xl bg-brand-primary px-4 py-2 text-sm font-semibold text-white shadow hover:bg-brand-primary/90"
        [disabled]="isSearching"
      >
        {{ isSearching ? 'Searching...' : 'Search' }}
      </button>
      <button type="button" class="text-sm text-brand-neutral" (click)="close()">
        Cancel
      </button>
    </div>
  </form>
  }

  @if (errorMessage) {
  <div class="rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
    {{ errorMessage }}
  </div>
  }

  @if (patients.length > 0) {
  <div class="space-y-3">
    <p class="text-sm font-medium text-brand-neutral">Select a matched patient</p>
    <div class="space-y-3">
      @for (patient of patients; track patient.patientID) {
      <button
        type="button"
        (click)="usePatient(patient)"
        class="w-full rounded-2xl border border-brand-border bg-white px-4 py-3 text-left transition hover:border-brand-primary hover:shadow-md"
      >
        <p class="font-semibold text-brand-neutral">
          {{ patient.firstName }} {{ patient.lastName }}
        </p>
        <p class="text-sm text-brand-neutral/70">
          {{ patient.phoneNumber || 'N/A' }} |
          {{ patient.patientAge ? (patient.patientAge + ' yrs') : 'Age N/A' }} |
          {{ patient.gender || 'Gender N/A' }}
        </p>
      </button>
      }
    </div>
  </div>
  }

  @if (showManualEntry) {
  <form class="space-y-4" [formGroup]="manualForm" (ngSubmit)="submitManual()">
    <div class="grid gap-3 md:grid-cols-2">
      <div>
        <label class="block text-sm font-medium text-brand-neutral" for="patientName">Patient name</label>
        <input
          id="patientName"
          type="text"
          formControlName="patientName"
          class="w-full rounded-xl border border-brand-border px-4 py-2 focus:border-brand-primary focus:outline-none"
        />
        @if (manualSubmitted && manualControls['patientName'].invalid) {
        <p class="text-sm text-red-500">Required</p>
        }
      </div>
      <div>
        <label class="block text-sm font-medium text-brand-neutral" for="patientAge">Age</label>
        <input
          id="patientAge"
          type="number"
          min="0"
          formControlName="patientAge"
          class="w-full rounded-xl border border-brand-border px-4 py-2 focus:border-brand-primary focus:outline-none"
        />
        @if (manualSubmitted && manualControls['patientAge'].invalid) {
        <p class="text-sm text-red-500">Required</p>
        }
      </div>
    </div>

    <div class="grid gap-3 md:grid-cols-2">
      <div>
        <label class="block text-sm font-medium text-brand-neutral" for="patientGender">Gender</label>
        <select
          id="patientGender"
          formControlName="patientGender"
          class="w-full rounded-xl border border-brand-border px-4 py-2 focus:border-brand-primary focus:outline-none"
        >
          <option value="" disabled>Select gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        @if (manualSubmitted && manualControls['patientGender'].invalid) {
        <p class="text-sm text-red-500">Required</p>
        }
      </div>
      <div>
        <label class="block text-sm font-medium text-brand-neutral" for="patientBloodGroup">Blood group</label>
        <input
          id="patientBloodGroup"
          type="text"
          formControlName="patientBloodGroup"
          placeholder="e.g. O+"
          class="w-full rounded-xl border border-brand-border px-4 py-2 focus:border-brand-primary focus:outline-none"
        />
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-brand-neutral" for="manualMobile">Mobile number</label>
      <input
        id="manualMobile"
        type="tel"
        formControlName="patientPhoneNo"
        class="w-full rounded-xl border border-brand-border px-4 py-2 focus:border-brand-primary focus:outline-none"
      />
      @if (manualSubmitted && manualControls['patientPhoneNo'].invalid) {
      <p class="text-sm text-red-500">Required</p>
      }
    </div>

    <div class="flex justify-end gap-3 pt-2">
      <button type="button" class="text-sm text-brand-neutral" (click)="close()">
        Cancel
      </button>
      <button
        type="submit"
        class="rounded-xl bg-brand-primary px-4 py-2 text-sm font-semibold text-white shadow hover:bg-brand-primary/90"
      >
        Save patient
      </button>
    </div>
  </form>
  }
</div>
