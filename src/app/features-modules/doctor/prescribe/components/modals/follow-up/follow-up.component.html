<div class="prescripto-modal">
  <header class="prescripto-modal__header">
    <div class="space-y-2">
      <p class="prescripto-modal__pill">Care continuity</p>
      <h2 class="prescripto-modal__title">Follow up</h2>
      <p class="prescripto-modal__subhead">
        Set thoughtful reminders so patients know exactly when to check in next.
      </p>
    </div>
    <div class="prescripto-modal__stats">
      <p class="prescripto-modal__stats-label">Scheduled</p>
      <p class="prescripto-modal__stats-value">{{ selectedFollowUps.length }}</p>
    </div>
  </header>

  <section class="prescripto-modal__search">
    <form (ngSubmit)="addFollowUp({ label: searchControl.value || '', value: 0 })">
      <div class="prescripto-modal__search-field">
        <svg class="prescripto-modal__search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"
            d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm6-2 4 4" />
        </svg>
        <input type="text" matInput [formControl]="searchControl" [matAutocomplete]="auto"
          placeholder="Search follow ups" />
        <mat-autocomplete [displayWith]="displayWith" #auto="matAutocomplete">
          @for (item of filteredFollowup | async; track item.label) {
          <mat-option (click)="addFollowUp(item)" [value]="item.label">
            {{ item.label }}
          </mat-option>
          }
        </mat-autocomplete>
      </div>
      <button class="btn-secondary w-full min-w-[150px] md:w-auto" type="submit">Add follow-up</button>
    </form>
    <p class="prescripto-modal__hint">Bookmark frequent plans for one-tap scheduling</p>
  </section>

  <mat-dialog-content class="prescripto-modal__body">
    @if (bookmarkedFollowup.length > 0) {
    <section class="prescripto-modal__chip-set">
      <div class="text-xs uppercase tracking-[0.35em] text-brand-neutral/50">Quick picks</div>
      <mat-chip-listbox multiple>
        <mat-chip-option class="prescripto-chip" *ngFor="let followUp of bookmarkedFollowup"
          [selected]="isFollowUpSelected(followUp.label)" (selectionChange)="toggleFollowUp($event, followUp)">
          {{ followUp.label }}
        </mat-chip-option>
      </mat-chip-listbox>
    </section>
    }

    @if (bookmarkedFollowup.length == 0) {
    <div class="prescripto-modal__empty">
      <p class="text-lg font-semibold">No follow ups found</p>
      <p class="text-sm text-brand-neutral/60">Try searching and bookmarking a follow up to reuse it quickly.</p>
    </div>
    }

    <section *ngIf="selectedFollowUps.length > 0" class="space-y-3">
      <article *ngFor="let followUp of selectedFollowUps; let i = index"
        class="rounded-2xl border border-brand-border bg-white p-4 flex flex-wrap gap-4">
        <label class="flex-1 min-w-[180px] text-sm text-brand-neutral">
          <span class="text-xs uppercase tracking-[0.3em] text-brand-neutral/60">Duration</span>
          <input class="prescripto-field mt-2" [(ngModel)]="followUp.notes" placeholder="Add duration" />
        </label>
        <label class="flex-1 min-w-[200px] text-sm text-brand-neutral">
          <span class="text-xs uppercase tracking-[0.3em] text-brand-neutral/60">Follow up</span>
          <input class="prescripto-field mt-2" [(ngModel)]="followUp.name" placeholder="Enter follow up" />
        </label>
        <button type="button" (click)="removeFollowUp(followUp)"
          class="ml-auto inline-flex h-9 w-9 items-center justify-center rounded-full bg-red-50 text-red-500 transition hover:bg-red-100">
          <app-bin />
        </button>
      </article>
    </section>

    @if (selectedFollowUps.length == 0) {
    <div class="prescripto-modal__empty">
      <p class="text-lg font-semibold">No follow ups selected</p>
      <p class="text-sm text-brand-neutral/60">Add one now or pull from your saved list.</p>
    </div>
    }
  </mat-dialog-content>

  <mat-dialog-actions class="prescripto-modal__actions">
    <button class="btn-secondary-light" (click)="closeDialog()">Cancel</button>
    <button class="btn-secondary" (click)="save()">Save</button>
  </mat-dialog-actions>
</div>
