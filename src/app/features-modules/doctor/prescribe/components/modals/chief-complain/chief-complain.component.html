<div class="prescripto-modal">
  <header class="prescripto-modal__header">
    <div class="space-y-2">
      <p class="prescripto-modal__pill">Symptoms</p>
      <h2 class="prescripto-modal__title">Chief complaint</h2>
      <p class="prescripto-modal__subhead">
        Capture what the patient reports in their own words so it flows naturally into your assessment.
      </p>
    </div>
    <div class="prescripto-modal__stats">
      <p class="prescripto-modal__stats-label">Selected</p>
      <p class="prescripto-modal__stats-value">{{ selectedComplaints.length }}</p>
    </div>
  </header>

  <section class="prescripto-modal__search">
    <form (ngSubmit)="addComplaint({ label: searchControl.value || '', value: 0 })">
      <div class="prescripto-modal__search-field">
        <svg class="prescripto-modal__search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"
            d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm6-2 4 4" />
        </svg>
        <input type="text" matInput [formControl]="searchControl" [matAutocomplete]="auto"
          placeholder="Search complaints" />
        <mat-autocomplete (optionSelected)="onselect($event)" [displayWith]="displayWith" #auto="matAutocomplete">
          @for (complaint of filteredChiefComplaints | async; track complaint.value) {
          <mat-option [value]="complaint">
            {{ complaint.label }}
          </mat-option>
          }
        </mat-autocomplete>
      </div>
      <button [disabled]="isAddComplients"
        class="btn-secondary w-full min-w-[150px] md:w-auto disabled:bg-gray-200 disabled:text-gray-500" type="submit">
        {{ isAddComplients ? 'Adding...' : 'Add complaint' }}
      </button>
    </form>
    <p class="prescripto-modal__hint">Tag repeat symptoms for faster prescribing</p>
  </section>

  <mat-dialog-content class="prescripto-modal__body">
    @if (loading.isSkelton) {
    <app-skelton />
    }

    @if (loading.noDataFound && selectedComplaints.length == 0) {
    <div class="prescripto-modal__empty">
      <p class="text-lg font-semibold">No bookmarked complaints yet</p>
      <p class="text-sm text-brand-neutral/60">Start typing a phrase to save it for every consultation.</p>
    </div>
    }

    @if (!loading.isSkelton && bookmarkedComplaints.length > 0) {
    <section class="prescripto-modal__chip-set">
      <div class="text-xs uppercase tracking-[0.35em] text-brand-neutral/50">Quick picks</div>
      <mat-chip-listbox multiple>
        @for (complaint of bookmarkedComplaints; track complaint.value) {
        <mat-chip-option class="prescripto-chip" [selected]="isComplaintSelected(complaint.label)"
          (selectionChange)="toggleComplaint($event, complaint)">
          {{ complaint.label }}
        </mat-chip-option>
        }
      </mat-chip-listbox>
    </section>
    }

    @if (selectedComplaints.length > 0) {
    <section class="prescripto-modal__selection">
      <table class="prescripto-modal__table">
        <thead>
          <tr>
            <th>Complaint</th>
            <th>Duration</th>
            <th>Notes</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          @for (complaint of selectedComplaints; track i; let i = $index) {
          <tr>
            <td>
              <input type="text" [(ngModel)]="complaint.name" readonly class="prescripto-field prescripto-field--readonly" />
            </td>
            <td>
              <input #durationInput type="text" [(ngModel)]="complaint.duration" placeholder="e.g. 3 days"
                (keydown.enter)="$event.preventDefault(); notesInput.focus()" class="prescripto-field" />
            </td>
            <td>
              <input #notesInput type="text" [(ngModel)]="complaint.notes" placeholder="Add notes"
                (keydown.enter)="$event.preventDefault(); saveButton?.click()" class="prescripto-field" />
            </td>
            <td class="text-center">
              <button type="button" (click)="removeComplaint(i)"
                class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-red-50 text-red-500 transition hover:bg-red-100">
                <app-bin></app-bin>
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </section>
    }
  </mat-dialog-content>

  <mat-dialog-actions class="prescripto-modal__actions">
    <button class="btn-secondary-light" (click)="closeDialog()">Cancel</button>
    <button #saveButton class="btn-secondary" (click)="saveComplaints()">Save</button>
  </mat-dialog-actions>
</div>
