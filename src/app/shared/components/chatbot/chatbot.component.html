<!-- Chat Button -->
<button (click)="toggleChat()"
  class="fixed bottom-6 right-6 bg-primary hover:bg-primaryAccent text-white p-4 rounded-full shadow-lg transition-all duration-300 z-50 flex items-center justify-center"
  [class.rotate-90]="isOpen">
  <svg *ngIf="!isOpen" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
    stroke="currentColor" class="w-8 h-8">
    <path stroke-linecap="round" stroke-linejoin="round"
      d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.159 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
  </svg>
  <svg *ngIf="isOpen" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
    stroke="currentColor" class="w-8 h-8">
    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
  </svg>
</button>

<!-- Chat Window -->
<div *ngIf="isOpen"
  class="fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-brand-card flex flex-col overflow-hidden z-50 border border-brand-border animate-fade-in-up">
  <!-- Header -->
  <div class="bg-primary p-4 flex items-center justify-between gap-3">
    <h3 class="text-white font-semibold text-lg">Prescripto Assistant</h3>
    <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide">
      <button type="button" (click)="startNewConversation()"
        class="px-3 py-1 border border-white/40 text-white rounded-full hover:bg-white/20 transition-colors">
        New Chat
      </button>
      <button type="button" (click)="clearChatHistory()"
        class="px-3 py-1 border border-white/40 text-white rounded-full hover:bg-white/20 transition-colors">
        Clear
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div #scrollContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-brand-surface">
    <div *ngFor="let msg of messages" class="flex"
      [ngClass]="{'justify-end': msg.sender === 'user', 'justify-start': msg.sender === 'agent'}">
      <div [ngClass]="{
        'bg-primary text-white rounded-br-none': msg.sender === 'user',
        'bg-white text-brand-neutral border border-brand-border rounded-bl-none': msg.sender === 'agent'
      }" class="max-w-[80%] p-3 rounded-2xl shadow-sm text-sm">
        <div class="markdown-content" [innerHTML]="msg.text | markdown"></div>
      </div>
    </div>

    <!-- Typing Indicator -->
    <div *ngIf="isTyping" class="flex justify-start">
      <div
        class="bg-white border border-brand-border p-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1 items-center">
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="p-4 bg-white border-t border-brand-border">
    <div class="flex gap-2">
      <input [(ngModel)]="userInput" (keyup.enter)="sendMessage()" type="text" placeholder="Type your message..."
        class="flex-1 px-4 py-2 border border-brand-border rounded-full focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary text-sm">
      <button (click)="sendMessage()" [disabled]="!userInput.trim() || isTyping"
        class="bg-primary text-white p-2 rounded-full hover:bg-primaryAccent disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path
            d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
        </svg>
      </button>
    </div>
  </div>
</div>
